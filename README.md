# üõ°Ô∏è EMBER MALWARE DETECTION - COMPLETE GUIDE

## üìã T·ªïng quan d·ª± √°n

**EMBER (Elastic Malware Benchmark for Empowering Researchers)** l√† m·ªôt h·ªá th·ªëng ph√°t hi·ªán malware t·ª± ƒë·ªông s·ª≠ d·ª•ng Machine Learning, ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi Elastic Security.

### üéØ D·ª± √°n n√†y gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ g√¨:

- **Ph√°t hi·ªán malware t·ª± ƒë·ªông**: T·ª± ƒë·ªông ph√¢n lo·∫°i file PE (Windows executable) l√† malware hay benign
- **B·∫£o m·∫≠t h·ªá th·ªëng**: B·∫£o v·ªá m√°y t√≠nh kh·ªèi c√°c ph·∫ßn m·ªÅm ƒë·ªôc h·∫°i
- **Nghi√™n c·ª©u AI/ML**: Cung c·∫•p benchmark dataset cho c·ªông ƒë·ªìng nghi√™n c·ª©u
- **·ª®ng d·ª•ng th·ª±c t·∫ø**: T√≠ch h·ª£p v√†o h·ªá th·ªëng antivirus, email security, endpoint protection

### üîç C√°ch ho·∫°t ƒë·ªông:

1. **Input**: File PE (.exe, .dll, .sys) c·ªßa Windows
2. **Feature Extraction**: Tr√≠ch xu·∫•t 2381 features t·ª´ PE file (headers, sections, imports, strings...)
3. **Machine Learning**: S·ª≠ d·ª•ng LightGBM ƒë·ªÉ ph√¢n lo·∫°i
4. **Output**: X√°c su·∫•t malware (0.0 = benign, 1.0 = malicious)

---

## ‚ö° QUICK START - C√ÅCH CH·∫†Y NHANH

### üöÄ Ph∆∞∆°ng √°n 1: Ch·∫°y tr·ª±c ti·∫øp (Khuy·∫øn ngh·ªã)

```bash
# 1. Ch·∫°y training script
python colab_guide/ember_pycharm.py

# 2. ƒê·ª£i training ho√†n t·∫•t (30-60 ph√∫t)
# 3. Model s·∫Ω ƒë∆∞·ª£c l∆∞u: colab_guide/ember_model_pycharm.txt
```

### üê≥ Ph∆∞∆°ng √°n 2: S·ª≠ d·ª•ng Docker

```bash
# 1. Kh·ªüi ƒë·ªông Docker Desktop
# 2. Build image
docker build -t ember-malware-detection .

# 3. Ch·∫°y container
docker run -it --rm -v "%cd%":/workspace ember-malware-detection /bin/bash

# 4. Trong container, ch·∫°y training
python /workspace/colab_guide/ember_pycharm.py
```

### üìä Ph∆∞∆°ng √°n 3: Google Colab

1. M·ªü file `colab_guide/ember_colab_notebook.ipynb`
2. Upload l√™n Google Colab
3. Ch·∫°y t·∫•t c·∫£ cells
4. Training s·∫Ω ch·∫°y tr√™n GPU mi·ªÖn ph√≠

---

## üöÄ H∆Ø·ªöNG D·∫™N CHI TI·∫æT

### üìã Y√™u c·∫ßu h·ªá th·ªëng

- **RAM**: T·ªëi thi·ªÉu 8GB (khuy·∫øn ngh·ªã 16GB+)
- **Storage**: 50GB tr·ªëng
- **Python**: 3.8+ (khuy·∫øn ngh·ªã 3.10)
- **OS**: Windows 10/11, Linux, macOS

### üéØ C√°c ph∆∞∆°ng √°n ch·∫°y

#### 1. üöÄ Ch·∫°y tr·ª±c ti·∫øp (ƒê∆°n gi·∫£n nh·∫•t)

```bash
# B∆∞·ªõc 1: ƒê·∫£m b·∫£o c√≥ Python 3.8+
python --version

# B∆∞·ªõc 2: Ch·∫°y training script
python colab_guide/ember_pycharm.py

# B∆∞·ªõc 3: ƒê·ª£i training ho√†n t·∫•t
# - Loading data: 5-10 ph√∫t
# - Training: 30-60 ph√∫t
# - T·ªïng c·ªông: 45-70 ph√∫t
```

#### 2. üê≥ S·ª≠ d·ª•ng Docker (·ªîn ƒë·ªãnh nh·∫•t)

```bash
# B∆∞·ªõc 1: C√†i ƒë·∫∑t Docker Desktop
# Download t·ª´: https://www.docker.com/products/docker-desktop/

# B∆∞·ªõc 2: Build image
docker build -t ember-malware-detection .

# B∆∞·ªõc 3: Ch·∫°y container
docker run -it --rm -v "%cd%":/workspace ember-malware-detection /bin/bash

# B∆∞·ªõc 4: Trong container
python /workspace/colab_guide/ember_pycharm.py
```

#### 3. üìä Google Colab (Mi·ªÖn ph√≠ GPU)

1. M·ªü [Google Colab](https://colab.research.google.com/)
2. Upload file `colab_guide/ember_colab_notebook.ipynb`
3. Ch·∫°y t·∫•t c·∫£ cells
4. Training s·∫Ω ch·∫°y tr√™n GPU T4 mi·ªÖn ph√≠

---

## üìä C√ÅCH S·ª¨ D·ª§NG MODEL SAU KHI TRAINING

### üéØ S·ª≠ d·ª•ng model ƒë√£ train

```python
import lightgbm as lgb
import ember

# 1. Load model ƒë√£ train
model = lgb.Booster(model_file="train/ember_model_pycharm.txt")

# 2. Ph√¢n t√≠ch file PE
def analyze_file(file_path):
    score = ember.predict_sample(model, file_path, feature_version=2)
    return score

# 3. Test v·ªõi file
score = analyze_file("test_file.exe")
print(f"Malware probability: {score:.4f}")
print(f"Prediction: {'Malware' if score > 0.5 else 'Benign'}")
```

### üîç Batch analysis nhi·ªÅu file

```python
import os
import lightgbm as lgb
import ember

# Load model
model = lgb.Booster(model_file="train/ember_model_pycharm.txt")

# Ph√¢n t√≠ch th∆∞ m·ª•c
def analyze_directory(directory):
    results = []
    for filename in os.listdir(directory):
        if filename.endswith(('.exe', '.dll', '.sys')):
            file_path = os.path.join(directory, filename)
            try:
                score = ember.predict_sample(model, file_path, feature_version=2)
                results.append({
                    'file': filename,
                    'malware_prob': score,
                    'prediction': 'Malware' if score > 0.5 else 'Benign'
                })
            except Exception as e:
                print(f"Error analyzing {filename}: {e}")
    return results

# S·ª≠ d·ª•ng
results = analyze_directory("path/to/pe/files/")
for result in results:
    print(f"{result['file']}: {result['prediction']} ({result['malware_prob']:.4f})")
```

### üìà Hi·ªáu su·∫•t model

- **Accuracy**: > 95%
- **ROC AUC**: > 0.99
- **False Positive Rate**: < 1%
- **Speed**: V√†i gi√¢y/file

---

## üìÅ C·∫§U TR√öC D·ª∞ √ÅN

### üìÇ Th∆∞ m·ª•c ch√≠nh:

```
ember/
‚îú‚îÄ‚îÄ colab_guide/                    # Training scripts
‚îÇ   ‚îú‚îÄ‚îÄ ember_pycharm.py           # Script ch·∫°y tr√™n PyCharm/VSCode
‚îÇ   ‚îú‚îÄ‚îÄ ember_colab_notebook.ipynb # Script ch·∫°y tr√™n Google Colab
‚îÇ   ‚îú‚îÄ‚îÄ ember_model_pycharm.txt    # Model ƒë√£ train (s·∫Ω t·∫°o)
‚îÇ   ‚îî‚îÄ‚îÄ ember_training.log         # Log file training
‚îú‚îÄ‚îÄ data/ember2018/                # Dataset EMBER2018
‚îÇ   ‚îú‚îÄ‚îÄ train_features_0.jsonl    # Features training
‚îÇ   ‚îú‚îÄ‚îÄ train_features_1.jsonl
‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ train_features_5.jsonl
‚îÇ   ‚îî‚îÄ‚îÄ test_features.jsonl        # Features testing
‚îú‚îÄ‚îÄ ember/                         # EMBER source code
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ features.py
‚îú‚îÄ‚îÄ scripts/                       # Utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ classify_binaries.py
‚îÇ   ‚îî‚îÄ‚îÄ init_ember.py
‚îî‚îÄ‚îÄ README.md                      # H∆∞·ªõng d·∫´n n√†y
```

### üìä Dataset EMBER2018:

- **K√≠ch th∆∞·ªõc**: 1M file PE
- **Features**: 2381 features/file
- **Labels**: 0 (benign) ho·∫∑c 1 (malware)
- **Format**: JSONL files

---

## üîß C√ÅC SCRIPT TRAINING

### 1. üöÄ ember_pycharm.py (Khuy·∫øn ngh·ªã)

```bash
# Ch·∫°y training tr√™n PyCharm/VSCode
python colab_guide/ember_pycharm.py

# Script s·∫Ω:
# - T·ª± ƒë·ªông c√†i ƒë·∫∑t dependencies
# - Load dataset t·ª´ data/ember2018/
# - Training LightGBM model
# - L∆∞u model: colab_guide/ember_model_pycharm.txt
```

### 2. üìä ember_colab_notebook.ipynb

```bash
# Upload l√™n Google Colab
# Ch·∫°y t·∫•t c·∫£ cells
# Training tr√™n GPU mi·ªÖn ph√≠
```

### 3. üõ†Ô∏è Utility scripts

```bash
# Ph√¢n t√≠ch file PE v·ªõi model ƒë√£ train
python scripts/classify_binaries.py -m colab_guide/ember_model_pycharm.txt file.exe

# T·∫°o metadata (n·∫øu c·∫ßn)
python scripts/init_ember.py -m data/ember2018/
```

---

## üìà HI·ªÜU SU·∫§T MODEL

### EMBER Model Performance:

- **ROC AUC**: > 0.99
- **False Positive Rate**: < 1%
- **Detection Rate**: > 95%
- **Speed**: V√†i gi√¢y/file

### So s√°nh v·ªõi MalConv:

- **EMBER (LightGBM)**: Nhanh, ch√≠nh x√°c cao
- **MalConv (CNN)**: Ch·∫≠m h∆°n, c·∫ßn GPU

---

## üîç FEATURES ƒê∆Ø·ª¢C TR√çCH XU·∫§T

### 1. Byte-level Features (416 features):

- **ByteHistogram**: Ph√¢n b·ªë byte (256 features)
- **ByteEntropyHistogram**: Entropy c·ªßa byte (256 features)

### 2. String Features (104 features):

- **StringExtractor**: Chu·ªói trong file
- **Paths, URLs, Registry**: C√°c pattern ƒë·∫∑c bi·ªát

### 3. PE Structure Features (1861 features):

- **GeneralFileInfo**: Th√¥ng tin chung (10 features)
- **HeaderFileInfo**: Th√¥ng tin header (62 features)
- **SectionInfo**: Th√¥ng tin sections (255 features)
- **ImportsInfo**: Th∆∞ vi·ªán import (1280 features)
- **ExportsInfo**: H√†m export (128 features)
- **DataDirectories**: Data directories (30 features)

**T·ªïng c·ªông: 2381 features**

---

## üõ†Ô∏è T√çCH H·ª¢P V√ÄO H·ªÜ TH·ªêNG

### 1. API Service

```python
from flask import Flask, request, jsonify
import ember
import lightgbm as lgb

app = Flask(__name__)
model = lgb.Booster(model_file="ember_model.txt")

@app.route('/analyze', methods=['POST'])
def analyze_file():
    file_data = request.files['file'].read()
    prediction = ember.predict_sample(model, file_data)
    return jsonify({'malware_probability': prediction})

if __name__ == '__main__':
    app.run(debug=True)
```

### 2. Batch Processing

```python
import os
import ember

def analyze_directory(directory_path, model):
    results = []
    for filename in os.listdir(directory_path):
        if filename.endswith('.exe'):
            file_path = os.path.join(directory_path, filename)
            with open(file_path, 'rb') as f:
                file_data = f.read()
            prediction = ember.predict_sample(model, file_data)
            results.append({'file': filename, 'malware_prob': prediction})
    return results
```

---

## üê≥ DOCKER COMMANDS

### Build v√† ch·∫°y

```bash
# Build image
docker build -t ember-malware-detection .

# Ch·∫°y container
docker run -it --rm -v "%cd%":/workspace ember-malware-detection /bin/bash

# Ch·∫°y v·ªõi Docker Compose
docker-compose up -d
```

### Qu·∫£n l√Ω container

```bash
# Xem containers ƒëang ch·∫°y
docker ps

# V√†o container
docker exec -it ember-malware-detection /bin/bash

# D·ª´ng container
docker-compose down
```

---

## üìö T√ÄI LI·ªÜU THAM KH·∫¢O

### Papers:

1. **EMBER Paper**: https://arxiv.org/abs/1804.04637
2. **MalConv Paper**: https://arxiv.org/abs/1710.09435

### Datasets:

- **EMBER 2017**: https://ember.elastic.co/ember_dataset.tar.bz2
- **EMBER 2018**: https://ember.elastic.co/ember_dataset_2018_2.tar.bz2

### GitHub:

- **EMBER Repository**: https://github.com/elastic/ember
- **LIEF Library**: https://github.com/lief-project/LIEF

---

## üö® L∆ØU √ù QUAN TR·ªåNG

### 1. B·∫£o m·∫≠t:

- **Ch·ªâ ph√¢n t√≠ch file PE**: EMBER ch·ªâ ho·∫°t ƒë·ªông v·ªõi file PE
- **Sandbox environment**: Ch·∫°y trong Docker ƒë·ªÉ an to√†n
- **Qu√©t virus tr∆∞·ªõc**: Ki·ªÉm tra file tr∆∞·ªõc khi ph√¢n t√≠ch

### 2. Hi·ªáu su·∫•t:

- **Memory usage**: C·∫ßn √≠t nh·∫•t 8GB RAM cho dataset l·ªõn
- **CPU intensive**: Qu√° tr√¨nh training c·∫ßn CPU m·∫°nh
- **Storage**: Dataset c·∫ßn ~50GB dung l∆∞·ª£ng

### 3. T∆∞∆°ng th√≠ch:

- **Python 3.8+**: Khuy·∫øn ngh·ªã s·ª≠ d·ª•ng Python 3.8
- **LIEF 0.9.0**: Phi√™n b·∫£n c·ªë ƒë·ªãnh ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n
- **Windows/Linux**: Ho·∫°t ƒë·ªông tr√™n c·∫£ hai h·ªá ƒëi·ªÅu h√†nh

---

## üîç TROUBLESHOOTING

### L·ªói th∆∞·ªùng g·∫∑p:

#### 1. Docker kh√¥ng ch·∫°y

```bash
# Kh·ªüi ƒë·ªông Docker Desktop
# Ki·ªÉm tra: docker ps
```

#### 2. LIEF installation error

```bash
# S·ª≠ d·ª•ng Docker thay v√¨ c√†i ƒë·∫∑t tr·ª±c ti·∫øp
docker run -it ember-malware-detection /bin/bash
```

#### 3. Memory error

```bash
# TƒÉng memory limit cho Docker
docker run -m 8g ember-malware-detection
```

#### 4. File not found

```bash
# Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file
# ƒê·∫£m b·∫£o file PE t·ªìn t·∫°i v√† c√≥ quy·ªÅn ƒë·ªçc
```

---

## üÜò H·ªñ TR·ª¢

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ:

1. Ki·ªÉm tra log l·ªói chi ti·∫øt
2. ƒê·∫£m b·∫£o Docker ƒëang ch·∫°y
3. Ki·ªÉm tra quy·ªÅn truy c·∫≠p file
4. Tham kh·∫£o GitHub issues: https://github.com/elastic/ember/issues

---

## üìä K·∫æT QU·∫¢ MONG ƒê·ª¢I

- **Malware probability**: 0.0 (benign) ƒë·∫øn 1.0 (malicious)
- **Features extracted**: 2381 features
- **Processing time**: V√†i gi√¢y/file
- **Accuracy**: > 95%

---

**Ch√∫c b·∫°n s·ª≠ d·ª•ng EMBER th√†nh c√¥ng! üéâ**
